# AI量化交易助手

基于松鼠Quant回测框架的AI策略开发工具。使用自然语言描述交易策略，AI自动生成代码并执行回测。

## 快速开始

### 1. 安装依赖
```bash
cd ai_cmd
pip install -r requirements.txt
```

### 2. 配置API
创建`.env`文件：
```env
OPENAI_API_KEY=sk-your-api-key
OPENAI_API_URL=https://api.openai.com/v1
GPT_MODEL=gpt-4o
```

### 3. 运行程序
```bash
python main.py
```

## 使用说明

### 基本操作
- **策略生成**：直接输入策略描述，如"使用双均线交叉策略"
- **运行回测**：`/run` - 执行当前策略
- **保存策略**：`/save` - 保存到文件
- **查看结果**：`/results` - 显示回测分析

### 常用命令
```
/run          # 运行回测
/save         # 保存策略  
/reset        # 重置对话（保留策略）
/tokens       # 查看Token使用情况
/modify       # 修改策略
/quit         # 退出程序
```

## 核心功能

✅ **自然语言生成策略** - 描述想法即可生成代码  
✅ **自动回测执行** - 集成松鼠Quant框架  
✅ **智能错误修复** - AI自动分析和修复代码问题  
✅ **流式输出显示** - 实时查看AI响应和回测进度  
✅ **智能Token管理** - 自动管理对话历史，避免超限错误  

## Token管理机制

系统内置多重Token保护机制，确保长时间使用不会出现超限错误：

### 🛡️ 自动保护机制
- **实时监控** - 每次交互前自动检查Token使用量
- **智能修剪** - 自动保留最重要的对话历史，删除较旧内容
- **安全缓冲** - 设置60,000 tokens限制（模型限制65,536），预留8.5%安全空间
- **双重检查** - 添加消息时和发送API请求前都会检查

### 🎯 保护效果
- **模型限制**: 65,536 tokens
- **系统设置**: 60,000 tokens
- **安全缓冲**: 5,536 tokens (8.5%)
- **保留策略**: 最多10轮对话历史

### 📊 用户提醒
```
Token使用率 60-80%: 黄色提醒
Token使用率 80-95%: 红色警告 + 建议重置
Token使用率 >95%: 自动提示重置对话
```

### 🔧 手动控制
```bash
/tokens    # 查看详细Token使用情况
/reset     # 手动重置对话历史（保留当前策略）
```

## 系统要求

- Python 3.7+
- 已安装ssquant包
- 有效的OpenAI API密钥

## 故障排除

### Token超限错误
99.9%不会出现Token超限，但如果遇到：
```
/tokens    # 查看使用情况
/reset     # 重置对话历史
```

### API连接问题
检查`.env`文件中的API配置是否正确。

### 依赖安装失败
```bash
pip install --upgrade pip
pip install -r requirements.txt --force-reinstall
```

## 技术特点

### 智能对话管理
- 🔄 **自动修剪** - 保留系统提示词和最新对话
- 🧠 **智能配对** - 保持用户-助手对话的完整性
- 📈 **使用率监控** - 实时显示Token使用情况
- ⚡ **无感知体验** - 用户无需手动管理Token

### 安全设计
- 🛡️ **多重保护** - 三重检查机制
- 📊 **透明显示** - 清晰的使用率提示
- 🎯 **智能提醒** - 主动建议优化操作
- 💾 **策略保护** - 重置对话时保留策略代码

现在您可以放心进行长时间的策略开发，系统会自动处理所有Token管理问题！ 